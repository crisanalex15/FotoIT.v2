<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Admin Dashboard - FotoIT</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}" />
  </head>
  <body>
    <div class="container">
      <h1>FotoIT - Admin Dashboard</h1>

      <!-- Modal pentru Success -->
      <div
        id="successModal"
        class="modal"
        th:if="${success}"
        th:attr="data-show=${success != null}"
      >
        <div class="modal-content modal-success">
          <span class="close-modal" onclick="closeModal('successModal')"
            >&times;</span
          >
          <div class="modal-icon">âœ…</div>
          <h2>Succes!</h2>
          <p th:text="${success}"></p>
          <button class="modal-btn" onclick="closeModal('successModal')">
            OK
          </button>
        </div>
      </div>

      <!-- Modal pentru Error -->
      <div
        id="errorModal"
        class="modal"
        th:if="${error}"
        th:attr="data-show=${error != null}"
      >
        <div class="modal-content modal-error">
          <span class="close-modal" onclick="closeModal('errorModal')"
            >&times;</span
          >
          <div class="modal-icon">âŒ</div>
          <h2>Eroare</h2>
          <p th:text="${error}"></p>
          <button class="modal-btn" onclick="closeModal('errorModal')">
            OK
          </button>
        </div>
      </div>

      <!-- Modal pentru Copiere Link -->
      <div id="copyLinkModal" class="modal">
        <div class="modal-content modal-info">
          <span class="close-modal" onclick="closeModal('copyLinkModal')"
            >&times;</span
          >
          <div class="modal-icon">ğŸ“‹</div>
          <h2>Link Copiat!</h2>
          <div class="copy-message">
            <p><strong>BunÄƒ! ğŸ‰</strong></p>
            <p>
              Pozele tale sunt gata È™i pot fi accesate folosind linkul sau codul
              de mai jos:
            </p>
            <div class="code-display" id="codeDisplay"></div>
            <p class="copy-success">âœ“ Link-ul a fost copiat Ã®n clipboard!</p>
          </div>
          <button class="modal-btn" onclick="closeModal('copyLinkModal')">
            Perfect!
          </button>
        </div>
      </div>

      <div class="create-form">
        <h2>CreeazÄƒ Eveniment Nou</h2>
        <form th:action="@{/admin/create}" method="post">
          <div class="form-group">
            <label>Google Drive Folder ID:</label>
            <input
              type="text"
              name="googleFolderId"
              required
              placeholder="1VO-g9pYA8KlF0lHofwrFqPwCpuD--yPF"
            />
          </div>
          <div class="form-group">
            <label>Tip Eveniment:</label>
            <select name="eventType" required>
              <option value="WEDDING">ğŸ’’ Nunta</option>
              <option value="SWEET_16">ğŸ‚ Majorat</option>
              <option value="EVENT">ğŸ‰ Eveniment</option>
            </select>
          </div>
          <div class="form-group">
            <label>Nume Eveniment (opÈ›ional):</label>
            <input type="text" name="name" placeholder="Nunta Maria & Ion" />
          </div>
          <div class="form-group">
            <label>Descriere (opÈ›ional):</label>
            <textarea name="description" rows="3"></textarea>
          </div>
          <button type="submit">CreeazÄƒ Eveniment</button>
        </form>
      </div>

      <div class="weddings-list">
        <h2>Evenimente Existente</h2>
        <table>
          <thead>
            <tr>
              <th>Cod</th>
              <th>Tip</th>
              <th>Nume</th>
              <th>Poze</th>
              <th>AcÈ›iuni</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="wedding : ${weddings}">
              <td th:text="${wedding.code}"></td>
              <td>
                <span
                  th:if="${wedding.eventType.name() == 'WEDDING'}"
                  class="badge badge-wedding"
                  >ğŸ’’ Nunta</span
                >
                <span
                  th:if="${wedding.eventType.name() == 'SWEET_16'}"
                  class="badge badge-sweet16"
                  >ğŸ‚ Majorat</span
                >
                <span
                  th:if="${wedding.eventType.name() == 'EVENT'}"
                  class="badge badge-event"
                  >ğŸ‰ Eveniment</span
                >
              </td>
              <td th:text="${wedding.name != null ? wedding.name : 'N/A'}"></td>
              <td th:text="${wedding.photoCount}"></td>
              <td>
                <a
                  th:href="@{/admin/{id}(id=${wedding.id})}"
                  class="btn btn-info"
                  >Detalii</a
                >
                <button
                  type="button"
                  class="btn btn-copy"
                  th:data-code="${wedding.code}"
                  th:data-name="${wedding.name != null ? wedding.name : ''}"
                  onclick="copyGalleryLinkFromButton(this)"
                >
                  ğŸ“‹ CopiazÄƒ Link
                </button>
                <form
                  th:action="@{/admin/{id}/sync(id=${wedding.id})}"
                  method="post"
                  style="display: inline"
                >
                  <button type="submit" class="btn btn-sync">ğŸ”„ Sync</button>
                </form>
                <form
                  th:action="@{/admin/{id}/delete(id=${wedding.id})}"
                  method="post"
                  style="display: inline"
                  onsubmit="return confirmDelete()"
                >
                  <button type="submit" class="btn btn-danger">
                    ğŸ—‘ï¸ È˜terge
                  </button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <script>
      // Ãnchide modal-urile cÃ¢nd se dÄƒ click pe X sau pe overlay
      document.querySelectorAll(".close-modal").forEach((closeBtn) => {
        closeBtn.addEventListener("click", function () {
          this.closest(".modal").style.display = "none";
        });
      });

      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };

      function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
      }

      // AfiÈ™eazÄƒ modal-urile automat dacÄƒ existÄƒ mesaje
      window.onload = function () {
        const successModal = document.getElementById("successModal");
        const errorModal = document.getElementById("errorModal");

        if (successModal && successModal.getAttribute("data-show") === "true") {
          successModal.style.display = "flex";
        }
        if (errorModal && errorModal.getAttribute("data-show") === "true") {
          errorModal.style.display = "flex";
        }
      };

      // FuncÈ›ie pentru copiere link galerie (foloseÈ™te data-* attributes)
      function copyGalleryLinkFromButton(button) {
        const code = button.getAttribute("data-code");
        const name = button.getAttribute("data-name") || "";
        copyGalleryLink(code, name);
      }

      // FuncÈ›ie pentru copiere link galerie
      function copyGalleryLink(code, name) {
        // ConstruieÈ™te URL-ul complet
        // Presupunem cÄƒ frontend-ul ruleazÄƒ pe localhost:3000 sau acelaÈ™i domain
        let baseUrl = window.location.origin;
        // DacÄƒ backend-ul e pe port 8080, schimbÄƒ la 3000 pentru frontend
        if (baseUrl.includes(":8080")) {
          baseUrl = baseUrl.replace(":8080", ":3000");
        }
        const galleryUrl = baseUrl + "/gallery/" + code;

        // CopiazÄƒ Ã®n clipboard
        navigator.clipboard
          .writeText(galleryUrl)
          .then(function () {
            // AfiÈ™eazÄƒ modal-ul cu mesajul pompos
            const codeDisplay = document.getElementById("codeDisplay");
            codeDisplay.innerHTML = `
                    <div class="code-box">
                        <div class="code-label">Cod:</div>
                        <div class="code-value">${code}</div>
                    </div>
                    <div class="link-box">
                        <div class="code-label">Link:</div>
                        <div class="code-value link-value">${galleryUrl}</div>
                    </div>
                `;
            document.getElementById("copyLinkModal").style.display = "flex";
          })
          .catch(function (err) {
            // Fallback pentru browsere vechi
            const textArea = document.createElement("textarea");
            textArea.value = galleryUrl;
            document.body.appendChild(textArea);
            textArea.select();
            try {
              document.execCommand("copy");
              const codeDisplay = document.getElementById("codeDisplay");
              codeDisplay.innerHTML = `
                        <div class="code-box">
                            <div class="code-label">Cod:</div>
                            <div class="code-value">${code}</div>
                        </div>
                        <div class="link-box">
                            <div class="code-label">Link:</div>
                            <div class="code-value link-value">${galleryUrl}</div>
                        </div>
                    `;
              document.getElementById("copyLinkModal").style.display = "flex";
            } catch (err2) {
              alert("Eroare la copiere. Te rog copiazÄƒ manual: " + galleryUrl);
            }
            document.body.removeChild(textArea);
          });
      }

      // Confirmare È™tergere cu modal
      function confirmDelete() {
        return confirm(
          "EÈ™ti sigur cÄƒ vrei sÄƒ È™tergi acest eveniment? AceastÄƒ acÈ›iune nu poate fi anulatÄƒ."
        );
      }
    </script>
  </body>
</html>
